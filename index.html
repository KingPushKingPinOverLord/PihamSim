<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Piham Simulator: Rosheeta's Wedding</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; user-select: none; }
        
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #crosshair { 
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; 
            background: #0f0; transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #0f0; z-index: 10;
        }

        .meter-box { 
            position: absolute; bottom: 30px; left: 30px;
            background: rgba(0, 20, 0, 0.9); 
            border: 2px solid #0f0; padding: 15px; width: 350px; 
        }
        .bar-bg { background: #003300; height: 20px; width: 100%; border: 1px solid #005500; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.1s linear; background: #00ff00; }
        
        #cooldown-msg { text-align: right; font-weight: bold; margin-top: 5px; color: yellow; }
        #safe-msg { color: lime; font-weight: bold; display: none; margin-top: 10px; }

        #objective-box { 
            position: absolute; top: 30px; left: 30px; color: #00ff00; 
            text-shadow: 0 0 5px #00ff00; font-size: 20px; font-weight: bold;
            background: rgba(0,0,0,0.8); padding: 15px; border: 2px solid #00ff00;
        }

        #subtitle-box {
            position: absolute; bottom: 200px; width: 100%; text-align: center; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; z-index: 9999;
        }
        .speaker-name {
            padding: 5px 15px; font-size: 18px; font-weight: 900;
            border: 2px solid #fff; border-bottom: none; margin-bottom: -2px; z-index: 2;
            text-transform: uppercase; background: #000;
        }
        .sub-text {
            display: inline-block; padding: 20px 40px; font-size: 24px; 
            font-weight: bold; border-radius: 10px; margin-bottom: 10px;
            text-shadow: 2px 2px 0 #000; max-width: 800px; 
            border: 3px solid #fff; position: relative; z-index: 1;
        }
        
        .piham-style .speaker-name { color: #00ffff; border-color: #00ffff; }
        .piham-style .sub-text { color: #00ffff; background: rgba(0,0,50,0.95); border-color: #00ffff; }
        .patel-style .speaker-name { color: #ff0000; border-color: #ff0000; }
        .patel-style .sub-text { color: #ffff00; background: rgba(50,0,0,0.95); border-color: #ff0000; }

        #boss-container {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 60%; display: none; text-align: center;
        }
        #boss-name {
            color: #ffcccc; font-size: 24px; text-transform: uppercase; 
            text-shadow: 0px 0px 10px red; letter-spacing: 2px; margin-bottom: 5px;
        }
        #boss-hp-bg { width: 100%; height: 20px; background: #330000; border: 2px solid #ff0000; }
        #boss-hp-fill { width: 100%; height: 100%; background: #ff0000; }

        #minimap-container {
            position: absolute; top: 30px; right: 30px;
            width: 200px; height: 200px;
            background: #000; border: 2px solid #00ff00;
            border-radius: 50%; overflow: hidden; opacity: 0.9;
        }
        #minimap { width: 100%; height: 100%; }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            pointer-events: auto; font-family: 'Courier New', monospace;
        }
        
        #start-screen h1 { font-size: 80px; color: #ff0000; margin: 0; text-shadow: 4px 4px 0 #330000; }
        #start-screen p { font-size: 18px; color: #aaaaaa; max-width: 600px; text-align: center; margin-top: 20px; }
        
        button { 
            padding: 20px 50px; font-size: 24px; cursor: pointer; 
            background: #000; color: #fff; border: 2px solid #fff; 
            font-weight: 900; margin-top: 40px; text-transform: uppercase;
            font-family: 'Courier New', monospace;
        }
        button:hover { background: #fff; color: #000; transform: scale(1.05); }

        #lose-screen h1 { color: gold; } 
        #win-screen h1 { color: cyan; } 
        #eaten-screen h1 { color: red; }

    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

</head>
<body>

    <div id="crosshair"></div>
    
    <div id="hud">
        <div id="objective-box">LOADING...</div>
        <div id="subtitle-box"></div>

        <div class="meter-box">
            <div style="font-weight: bold; color: #00ff00;">SOCIAL ANXIETY</div>
            <div class="bar-bg"><div id="anxiety-bar" class="bar-fill"></div></div>
            <div id="cooldown-msg">JOKE READY</div>
            <div id="safe-msg">[ SAFE ZONE - PATEL CAN'T ENTER ]</div>
        </div>
        
        <div id="boss-container">
            <div id="boss-name">KIAN (THE GROOM)</div>
            <div id="boss-hp-bg"><div id="boss-hp-fill"></div></div>
        </div>
        
        <div id="minimap-container"><canvas id="minimap" width="200" height="200"></canvas></div>
    </div>

    <div id="start-screen" class="screen">
        <h1>SOMNATH HEIGHTS</h1>
        <p style="color: #666;">Piham Simulator: Rosheeta's Wedding</p>
        <p style="margin-top: 30px; border: 1px solid #333; padding: 20px; color: #ddd;">
            Mission:<br>
            1. Ruin the "Birthday" Prank.<br>
            2. Ruin the "Presentation" Prank.<br>
            3. Stop the Wedding.<br>
            <br>
            WARNING: Aryan Patel is hungry. He wants to eat you.
        </p>
        <button id="start-btn" style="background: #cc0000; border: none;">ENTER SOMNATH</button>
    </div>

    <div id="lose-screen" class="screen" style="display:none">
        <h1 style="color:gold">TRUE ENDING</h1>
        <p style="color:white">You died. Kian married Rosheeta.</p>
        <p style="color:gold">Social Status: WEDDING CRASHER</p>
        <button onclick="location.reload()" style="border-color:gold; color:gold;">PLAY AGAIN</button>
    </div>

    <div id="win-screen" class="screen" style="display:none">
        <h1 style="color:cyan">FAKE ENDING</h1>
        <p style="color:white">You won? No... you just woke up.</p>
        <p style="color:cyan">It was all a dream.</p>
        <button onclick="location.reload()" style="border-color:cyan; color:cyan;">WAKE UP</button>
    </div>

    <div id="eaten-screen" class="screen" style="display:none">
        <h1 style="color:red">YOU WERE EATEN</h1>
        <p style="color:red">Aryan Patel ate you. Game Over.</p>
        <button onclick="location.reload()" style="border-color:red; color:red;">TRY AGAIN</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- DATA ---
        const DAD_JOKES = [
            "What do you call a fake noodle? An Impasta.",
            "I used to be a banker but I lost interest.",
            "Why don't skeletons fight? No guts.",
            "I'm on a seafood diet. I see food and I eat it."
        ];

        const PATEL_SCREAMS = [
            "MY EARS ARE BLEEDING!",
            "YOU ARE SO UNFUNNY PIHAM!",
            "I'M GONNA EAT YOU!",
            "STOP! PLEASE STOP!"
        ];

        // --- TEXTURE GENERATOR ---
        const TexGen = {
            createCanvas: function(w, h, color) {
                const c = document.createElement('canvas'); c.width = w; c.height = h;
                const ctx = c.getContext('2d'); ctx.fillStyle = color; ctx.fillRect(0,0,w,h);
                return {c, ctx};
            },
            wall: function() {
                const {c, ctx} = this.createCanvas(512, 512, '#f5f5dc'); 
                for(let i=0; i<5000; i++) {
                    ctx.fillStyle = Math.random()>0.5 ? '#e0e0c0' : '#ffffea';
                    ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
                }
                ctx.lineWidth = 40; ctx.strokeStyle = '#008080'; 
                ctx.strokeRect(0,0,512,512);
                return new THREE.CanvasTexture(c);
            },
            tile: function() {
                const {c, ctx} = this.createCanvas(512, 512, '#ffffff'); 
                ctx.fillStyle = '#e0e0e0';
                for(let i=0; i<4; i++) for(let j=0; j<4; j++) if((i+j)%2===0) ctx.fillRect(i*128, j*128, 128, 128);
                const t = new THREE.CanvasTexture(c); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(10, 15);
                return t;
            },
            ceiling: function() {
                const {c, ctx} = this.createCanvas(512, 512, '#333333');
                ctx.fillStyle = '#444'; 
                for(let i=0; i<1000; i++) ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
                const t = new THREE.CanvasTexture(c); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(10, 15);
                return t;
            },
            residentText: function() {
                const {c, ctx} = this.createCanvas(256, 64, 'rgba(0,0,0,0.8)');
                ctx.fillStyle = '#00ff00'; ctx.font = 'bold 24px Courier'; ctx.textAlign = 'center';
                ctx.fillText("SOMNATH RESIDENT", 128, 40);
                return new THREE.CanvasTexture(c);
            },
            jokeText: function(text) {
                const {c, ctx} = this.createCanvas(512, 128, 'rgba(0,0,0,0)');
                ctx.fillStyle = "#ffff00"; ctx.font = "bold 80px Impact"; 
                ctx.strokeStyle = "black"; ctx.lineWidth = 6;
                ctx.strokeText(text, 256, 100); ctx.textAlign = "center"; ctx.fillText(text, 256, 100);
                return new THREE.CanvasTexture(c);
            }
        };

        // --- AUDIO ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        const SoundGen = {
            init: () => { audioCtx = new AudioCtx(); },
            playTone: (freq, type, dur, vol=0.1) => {
                if(!audioCtx) return;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + dur);
            },
            playJoke: function() { 
                this.playTone(300, 'sawtooth', 0.2, 0.1); setTimeout(()=>this.playTone(200, 'sawtooth', 0.4, 0.1), 200);
            },
            playPop: function() { this.playTone(150, 'square', 0.1, 0.1); },
            playBossMusic: function() {
                if(this.bossInt) return;
                this.bossInt = setInterval(() => { this.playTone(60, 'sawtooth', 0.5, 0.1); }, 800);
            }
        };

        // --- GAME ENGINE ---
        const STATE = { hp: 100, anxiety: 0, stamina: 100, step: 0, isPlaying: false, bossActive: false, jokeTimer: 0, inSafeZone: false };
        let scene, camera, renderer, controls;
        let aryan, crackheads = [], walls = [], roomTriggers = [], projectiles = [], floaters = [];
        let lastTime = performance.now();
        let moveInput = { f:0, b:0, l:0, r:0 };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.FogExp2(0x0a0a0a, 0.03);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
            const flashlight = new THREE.PointLight(0xffaa00, 1, 30); camera.add(flashlight); scene.add(camera);

            controls = new PointerLockControls(camera, document.body);

            buildSomnathHeights();
            createAryan();
            for(let i=0; i<6; i++) createCrackhead();

            document.getElementById('start-btn').addEventListener('click', () => {
                document.getElementById('start-screen').style.display = 'none';
                controls.lock(); STATE.isPlaying = true; AudioEngine.init(); updateObjective();
            });

            document.addEventListener('mousedown', attemptJoke);
            document.addEventListener('keydown', (e)=>{ if(e.code==='KeyW') moveInput.f=1; if(e.code==='KeyS') moveInput.b=1; if(e.code==='KeyA') moveInput.l=1; if(e.code==='KeyD') moveInput.r=1; });
            document.addEventListener('keyup', (e)=>{ if(e.code==='KeyW') moveInput.f=0; if(e.code==='KeyS') moveInput.b=0; if(e.code==='KeyA') moveInput.l=0; if(e.code==='KeyD') moveInput.r=0; });

            animate();
        }

        function buildSomnathHeights() {
            const matWall = new THREE.MeshLambertMaterial({ map: TexGen.wall() });
            const matFloor = new THREE.MeshLambertMaterial({ map: TexGen.tile() });

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(30, 200), matFloor); floor.rotation.x = -Math.PI/2; scene.add(floor);
            
            // SEGMENTED HALLWAY WALLS
            createWall(-15, -80, 2, 60, matWall); 
            createWall(-15, -25, 2, 20, matWall); 
            createWall(-15, 50, 2, 100, matWall); 
            createWall(15, -50, 2, 100, matWall); 
            createWall(15, 60, 2, 80, matWall);   
            createWall(0, -125, 32, 2, matWall);
            createWall(0, 125, 32, 2, matWall);

            // ROOMS
            createRoom(-25, -45, "101", 0xff0000, true); // Kian
            createRoom(-25, -10, "102", 0x0000ff, false); // Dimitri
            createRoom(25, 40, "104", 0x00ff00, false);   
        }

        function createWall(x, z, w, d, mat) {
            const geo = new THREE.BoxGeometry(w, 10, d);
            const wall = new THREE.Mesh(geo, mat);
            wall.position.set(x, 5, z);
            scene.add(wall);
            walls.push(new THREE.Box3().setFromObject(wall));
        }

        function createRoom(x, z, label, lightColor, isParty) {
            const matWall = new THREE.MeshLambertMaterial({ map: TexGen.wall() });
            const matFloor = new THREE.MeshLambertMaterial({ map: TexGen.tile() });

            const f = new THREE.Mesh(new THREE.PlaneGeometry(18, 18), matFloor);
            f.rotation.x = -Math.PI/2; f.position.set(x, 0.1, z); scene.add(f);
            
            // Side Walls
            createWall(x > 0 ? x+15 : x-15, z, 2, 18, matWall);
            createWall(x, z-9, 18, 2, matWall);
            createWall(x, z+9, 18, 2, matWall);
            
            // Door Gap
            const wallX = x > 0 ? x-15 : x+15;
            createWall(wallX, z-6, 2, 6, matWall);
            createWall(wallX, z+6, 2, 6, matWall);
            const lintel = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 6), matWall);
            lintel.position.set(wallX, 8.5, z); scene.add(lintel);

            const l = new THREE.PointLight(lightColor, 1, 15); l.position.set(x, 8, z); scene.add(l);
            roomTriggers.push({ pos: new THREE.Vector3(x, 0, z), radius: 8, id: label });

            if(isParty) spawnKian(x, z);
            else if(label === '102') spawnDimi(x, z);
        }

        function spawnKian(x, z) {
            const kian = createHumanoid(0xff0000); kian.position.set(x, 3, z-3); scene.add(kian);
            const cake = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 1), new THREE.MeshLambertMaterial({color:0xff69b4}));
            cake.position.set(x, 1, z); scene.add(cake);
        }
        function spawnDimi(x, z) {
            const dimi = createHumanoid(0x0000ff); dimi.position.set(x, 3, z); scene.add(dimi);
        }

        function createHumanoid(color) {
            const g = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({color:color});
            const t = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 1), mat); g.add(t);
            const h = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshStandardMaterial({color:0x3d2314})); h.position.y=2; g.add(h);
            return g;
        }

        function createAryan() {
            aryan = new THREE.Group();
            const matSkin = new THREE.MeshLambertMaterial({ color: 0x3d2314 });
            const matShirt = new THREE.MeshLambertMaterial({ color: 0xffffff }); 
            const torso = new THREE.Mesh(new THREE.BoxGeometry(3, 4, 2), matShirt); torso.position.y = 4; aryan.add(torso);
            const head = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.8, 1.5), matSkin); head.position.y = 6.8; aryan.add(head);
            const lArm = new THREE.Mesh(new THREE.BoxGeometry(1, 3.5, 1), matSkin); lArm.position.set(-2, 4, 0); aryan.add(lArm);
            const rArm = new THREE.Mesh(new THREE.BoxGeometry(1, 3.5, 1), matSkin); rArm.position.set(2, 4, 0); aryan.add(rArm);
            const lLeg = new THREE.Mesh(new THREE.BoxGeometry(1, 3.5, 1), matSkin); lLeg.position.set(-0.8, 1.8, 0); aryan.add(lLeg);
            const rLeg = new THREE.Mesh(new THREE.BoxGeometry(1, 3.5, 1), matSkin); rLeg.position.set(0.8, 1.8, 0); aryan.add(rLeg);
            aryan.position.set(0, 0, -90); aryan.userData = { speed: 0.11, stunned: false }; 
            scene.add(aryan);
        }

        function createCrackhead() {
            const mesh = createHumanoid(0x00ff00);
            mesh.position.set((Math.random()-0.5)*20, 3, (Math.random()-0.5)*100);
            const sprite = createTextSprite("RESIDENT", "#00ff00");
            sprite.scale.set(4,1,1); sprite.position.y = 3.5; mesh.add(sprite);
            scene.add(mesh); crackheads.push(mesh);
        }

        // --- GAMEPLAY ---
        function attemptJoke() {
            if(!STATE.isPlaying || Date.now() < STATE.jokeTimer) return;
            STATE.jokeTimer = Date.now() + 3000;
            document.getElementById('cooldown-msg').innerText = "RECHARGING...";
            document.getElementById('cooldown-msg').style.color = "red";
            setTimeout(() => { document.getElementById('cooldown-msg').innerText = "JOKE READY"; document.getElementById('cooldown-msg').style.color = "yellow"; }, 3000);

            const joke = DAD_JOKES[Math.floor(Math.random() * DAD_JOKES.length)];
            showSubtitle("PIHAM", joke, "piham-style");

            // DELAYED REACTION
            setTimeout(() => {
                fireCringeNuke();
                checkObjectives();
            }, 2000);
        }

        function fireCringeNuke() {
            SoundGen.playJoke();
            const ring = new THREE.Mesh(new THREE.RingGeometry(1, 40, 32), new THREE.MeshBasicMaterial({color: 0xffff00, side: THREE.DoubleSide, transparent:true}));
            ring.rotation.x = -Math.PI/2; ring.position.copy(camera.position); ring.position.y = 1;
            scene.add(ring); projectiles.push({ mesh: ring, scale: 1, age: 0 });

            // Hit Patel
            if(camera.position.distanceTo(aryan.position) < 40) {
                if(STATE.bossActive) {
                    STATE.hp -= 5; updateBossBar();
                    showSubtitle("KIAN", "I'M MARRYING ROSHEETA NO MATTER WHAT!", "patel-style");
                } else {
                    aryan.userData.stunned = true;
                    showSubtitle("PATEL", PATEL_SCREAMS[Math.floor(Math.random()*PATEL_SCREAMS.length)], "patel-style");
                    setTimeout(() => aryan.userData.stunned = false, 5000);
                }
            }
        }

        function checkObjectives() {
            const pPos = camera.position;
            roomTriggers.forEach(room => {
                if(pPos.distanceTo(room.pos) < room.radius) {
                    // Mission 1: Talk to Kian (Fake Birthday)
                    if(STATE.step === 0 && room.id === '101') {
                        STATE.step = 1; updateObjective();
                        showSubtitle("KIAN", "Dimi's Bday was 4 months ago! Go ruin his day!", "patel-style");
                    }
                    // Mission 2: Tell Dimitri
                    else if(STATE.step === 1 && room.id === '102') {
                        STATE.step = 2; updateObjective();
                        showSubtitle("PIHAM", "Dimitri! Kian is pranking you. It's fake.", "piham-style");
                    }
                    // Mission 3: Talk to Kian (Presentation)
                    else if(STATE.step === 2 && room.id === '101') {
                        STATE.step = 3; updateObjective();
                        showSubtitle("KIAN", "I swapped his slides with memes! Go watch!", "patel-style");
                    }
                    // Mission 4: Tell Dimitri
                    else if(STATE.step === 3 && room.id === '102') {
                        STATE.step = 4; updateObjective();
                        showSubtitle("PIHAM", "Dimitri! Check your files! It's a prank!", "piham-style");
                    }
                    // Boss Fight
                    else if(STATE.step === 4 && room.id === '104') { // Using empty room as trigger
                         startBossFight();
                    }
                }
            });
        }

        function startBossFight() {
            if(STATE.bossActive) return;
            STATE.bossActive = true;
            document.getElementById('boss-hud').style.display = 'block';
            document.getElementById('objective-box').style.color = 'red';
            SoundGen.playBossMusic();
            aryan.scale.set(1.5, 1.5, 1.5); aryan.userData.speed = 0.35; 
            showSubtitle("KIAN", "I HAVE ROSHEETA'S HAND! FIGHT ME!", "patel-style");
            aryan.position.copy(camera.position).add(new THREE.Vector3(0,0,30));
        }

        function updateObjective() {
            const txt = [
                "TALK TO KIAN (ROOM 101)",
                "TELL DIMITRI (ROOM 102)",
                "RETURN TO KIAN (ROOM 101)",
                "WARN DIMITRI AGAIN (ROOM 102)",
                "STOP THE WEDDING (FIND KIAN)"
            ];
            document.getElementById('objective-box').innerText = "OBJ: " + txt[STATE.step];
        }

        function showSubtitle(speaker, text, css) {
            const box = document.getElementById('subtitle-box');
            box.innerHTML = `<div class="speaker-name ${css}">${speaker}</div><div class="sub-text ${css}">${text}</div>`;
            clearTimeout(window.subT); window.subT = setTimeout(() => box.innerHTML = '', 4000);
        }

        function updateBossBar() {
            const pct = Math.max(0, (STATE.hp / 100) * 100);
            document.getElementById('boss-fill').style.width = pct + "%";
            if(STATE.hp <= 0) {
                document.getElementById('win-screen').style.display = 'flex'; // FAKE ENDING
                controls.unlock();
            }
        }

        // --- PHYSICS ---
        function updatePlayer() {
            const speed = 15;
            const dir = new THREE.Vector3();
            dir.z = moveInput.f - moveInput.b; dir.x = moveInput.r - moveInput.l; dir.normalize();

            const camDir = new THREE.Vector3(); controls.getDirection(camDir); camDir.y = 0; camDir.normalize();
            const camSide = new THREE.Vector3().crossVectors(camera.up, camDir).normalize();
            const moveVec = new THREE.Vector3();
            if(moveInput.f) moveVec.add(camDir); if(moveInput.b) moveVec.sub(camDir);
            if(moveInput.r) moveVec.add(camSide); if(moveInput.l) moveVec.sub(camSide);
            moveVec.normalize().multiplyScalar(speed * 0.016);

            const nextPos = camera.position.clone().add(moveVec);
            const playerBox = new THREE.Box3().setFromCenterAndSize(nextPos, new THREE.Vector3(1, 4, 1));
            
            let collide = false;
            for(let wall of walls) { if(playerBox.intersectsBox(wall)) { collide = true; break; } }
            if(!collide) camera.position.add(moveVec);
            
            // Safe Zone Logic
            let safe = false;
            for(let e of roomTriggers) if(camera.position.distanceTo(e.pos) < e.radius) safe = true;
            STATE.inSafeZone = safe;
            document.getElementById('safe-msg').style.display = safe ? 'block' : 'none';
        }

        function updateEnemy() {
            if(!aryan.userData.stunned) {
                const pPos = camera.position;
                if(pPos.distanceTo(aryan.position) < 3) {
                    if(STATE.bossActive) {
                         document.getElementById('lose-screen').style.display = 'flex'; // TRUE ENDING
                    } else {
                         document.getElementById('eaten-screen').style.display = 'flex';
                    }
                    controls.unlock(); STATE.isPlaying = false;
                }
                
                if(STATE.inSafeZone && !STATE.bossActive) {
                    aryan.lookAt(pPos); // Stare
                } else {
                    const dir = new THREE.Vector3().subVectors(pPos, aryan.position).normalize();
                    aryan.position.add(dir.multiplyScalar(aryan.userData.speed));
                    aryan.lookAt(pPos);
                }
            }
        }

        // --- LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            if(!STATE.isPlaying) return;
            if(controls.isLocked) updatePlayer();
            updateEnemy();
            
            projectiles.forEach((p, i) => {
                p.scale += 0.5; p.mesh.scale.set(p.scale, p.scale, p.scale);
                p.mesh.material.opacity = 1 - (p.scale/40);
                if(p.scale > 40) { scene.remove(p.mesh); projectiles.splice(i, 1); }
            });
            
            // Minimap
            const ctx = document.getElementById('minimap').getContext('2d');
            ctx.fillStyle='#000'; ctx.fillRect(0,0,200,200);
            const p = camera.position;
            ctx.save(); ctx.translate(100,100); ctx.rotate(-camera.rotation.y); ctx.translate(-p.x*3, -p.z*3);
            ctx.fillStyle='#008080'; walls.forEach(w => { const width = w.max.x - w.min.x; const depth = w.max.z - w.min.z; ctx.fillRect(w.min.x*3, w.min.z*3, width*3, depth*3); });
            ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(aryan.position.x*3, aryan.position.z*3, 5, 0, 6.28); ctx.fill();
            ctx.restore();
            ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(100,100,4,0,6.28); ctx.fill();

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
